# Face-Recognition-Project

## Структура проекта

```
Face-Recognition-Project/
├── face_detection/         # Модуль детекции лиц
│   ├── requirements.txt
│   ├── README.md
│   └── src/
│       ├── detector.py     # MTCNN детектор
│       └── app.py          # Gradio Web UI
├── notebooks/              # Jupyter notebooks
└── Project/                # Другие модули
```

## Face Detection

Модуль детекции лиц находится в папке `face_detection/`. 

**Быстрый старт:**
```bash
cd face_detection
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python -m src.app
```

Откройте http://localhost:7860 в браузере.

---

## Отбор и фильтрация изображений

#### Загрузка и анализ данных

**Загружаемые файлы:**
- `img_celeba/` - оригинальные изображения (202,599 фото)
- `identity_CelebA.txt` - связь изображений с персонами (10,177 персон)
- `list_attr_celeba.txt` - 40 бинарных атрибутов
- `list_bbox_celeba.txt` - координаты bounding boxes
- `list_landmarks_celeba.txt` - 5 ключевых точек лица (НЕ выровненные)

**Анализ данных:**
- Распределение количества фото на персону
- Частота атрибутов (пол, возраст, улыбка, очки и т.д.)
- Качество изображений (размытость, размер bbox, расстояние между глазами)
- Баланс по полу и другим атрибутам

#### Фильтрация по качеству

**Статистический анализ:**
- Анализ распределения площади bounding box
- Анализ распределения расстояния между глазами
- Установка границ на основе whiskers (Q1 - 1.5×IQR, Q3 + 1.5×IQR)

**Критерии фильтрации:**
1. **Размытость**: Исключены все изображения с атрибутом Blurry = 1
2. **Площадь bbox**: Исключены изображения вне диапазона [BBOX_AREA_MIN, BBOX_AREA_MAX]
3. **Расстояние между глазами**: Исключены изображения вне диапазона [EYE_DIST_MIN, EYE_DIST_MAX]

#### Отбор персон

**Критерии:**
- Минимум 20 качественных фото на персону
- Максимум 35 качественных фото на персону

**Обоснование:**
- < 20 фото: недостаточно примеров для обучения модели
- > 35 фото: риск дисбаланса, некоторые персоны будут переобучены

#### Ранжирование по разнообразию (Diversity Score)

**Алгоритм:**
Для каждой персоны вычисляется diversity score на основе разнообразия атрибутов в её фотографиях.

**Ключевые атрибуты для оценки разнообразия:**
- Male (пол)
- Young (возраст)
- Smiling (улыбка)
- Eyeglasses (очки)
- Heavy_Makeup (макияж)
- Wearing_Hat (головной убор)
- Attractive (привлекательность)
- Black_Hair, Blond_Hair, Brown_Hair (цвет волос)
- Mouth_Slightly_Open (приоткрытый рот)
- Wearing_Lipstick (помада)

**Подсчет баллов:**
- +2 балла: если у персоны есть фото И с атрибутом И без него
- +1 балл: если все фото только с атрибутом ИЛИ только без
- 0 баллов: если атрибут не применим

**Результат:**
Персоны с высоким diversity score имеют фото в разных условиях съемки, с разными выражениями лица, аксессуарами и т.д.

#### Балансировка по полу

**Проблема:**
Женщины имеют в среднем более высокий diversity score (18.97 vs 17.39 у мужчин) из-за большего разнообразия атрибутов (макияж, цвет волос, помада и т.д.)

**Решение:**
Чередующийся отбор мужчин и женщин с контролем соотношения:
- Целевая доля мужчин: 42% (как в исходном датасете)
- Персоны сортируются по полу и diversity score отдельно
- Алгоритм динамически выбирает мужчину или женщину для поддержания баланса

#### Отбор разнообразных изображений

**Стратегия:**
От каждой персоны берутся ВСЕ доступные качественные фотографии (20-35 штук), но с приоритетом на разнообразие.

**Алгоритм:**
1. Для каждой персоны создаются уникальные "сигнатуры" - комбинации атрибутов
2. Изображения группируются по этим сигнатурам
3. Берется примерно равное количество из каждой группы
4. Это обеспечивает максимальное разнообразие поз, выражений, освещения

### Итоговая статистика

#### Общие показатели
- **Изображений**: ~10,000
- **Персон**: ~425
- **Среднее фото на персону**: ~23.5

#### Баланс по полу
- **Мужчины**: ~42% (соответствует исходному датасету)
- **Женщины**: ~58%

#### Качество
- **Размытые изображения**: 0% (все исключены)
- **Площадь bbox**: в пределах статистически нормального диапазона
- **Расстояние между глазами**: в пределах нормального диапазона

### Формат выходных данных

#### Структура датасета
```
celeba_subset_10k/
├── images/
│   ├── 000001.jpg
│   ├── 000002.jpg
│   └── ...
└── annotations/
    ├── identity_CelebA.txt
    ├── list_attr_celeba.txt
    ├── list_bbox_celeba.txt
    └── list_landmarks_celeba.txt
```

#### Формат файлов аннотаций

**identity_CelebA.txt:**
```
<image_id> <person_id>
000001.jpg 2880
000002.jpg 2937
...
```

**list_attr_celeba.txt:**
```
<количество_изображений>
<список_40_атрибутов>
<image_id> <attr1> <attr2> ... <attr40>
```
Значения: 1 (есть атрибут), -1 (нет атрибута)

**list_bbox_celeba.txt:**
```
<количество_изображений>
image_id x_1 y_1 width height
<image_id> <x_1> <y_1> <width> <height>
```

**list_landmarks_celeba.txt:**
```
<количество_изображений>
lefteye_x lefteye_y righteye_x righteye_y nose_x nose_y leftmouth_x leftmouth_y rightmouth_x rightmouth_y
<image_id> <lefteye_x> <lefteye_y> ... <rightmouth_y>
```
